manifest {
    name = 'config file for Sanger users, modified from The Wellcome Sanger Institute HPC cluster profile by Anthony Underwood (@aunderwo)'
    description = 'original config by Anthony Underwood (@aunderwo) https://www.sanger.ac.uk/group/informatics-support-group/'
}



process {
    resourceLimits = [
        memory: 2.9.TB,
        cpus: 256,
        time: 43200.min
        ]
    executor = 'lsf'
    errorStrategy = { task.exitStatus in ((130..145) + 104) ? 'retry' : 'finish' }
    maxRetries = 3

    queue = {
        if ( task.time >= 15.day ) {
            if ( task.memory > 680.GB ) {
                error "There is no queue for jobs that need >680 GB and >15 days"
            } else {
                "basement"
            }
        } else if ( task.memory > 720.GB ) {
            "teramem"
        } else if ( task.memory > 350.GB ) {
            "hugemem"
        } else if ( task.time > 7.day ) {
            "basement"
        } else if ( task.time > 2.day ) {
            "week"
        } else if ( task.time > 12.hour ) {
            "long"
        } else if ( task.time > 1.min ) {
            "normal"
        } else {
            "small"
        }
    }


    withLabel: caveman {
        container = "/software/CASM/singularity/cgpcavemanwrapper/cgpcavemanwrapper_1.19.1.sif"
    }

    withName: cgpPindel {
        container = "/software/CASM/singularity/cgppindel/cgppindel_3.10.0.sif"
    }

    withName: cgpBigWig {
        container = "/software/CASM/singularity/pcap-core/pcap-core_5.7.0.sif"
    }

    withName: vafAugment {
        container = "/software/CASM/singularity/vafcorrect/vafcorrect_5.7.2.sif"
    }

    withLabel: vagrent {
        container = "/software/CASM/singularity/vagrent/vagrent_v3.6.1.sif"
    }

    // the below is to deal with Farm connection issues as sometimes job submission is duplicated
    // resulting in error in Nextflow file staging

    withName: cavemanMstep {
        errorStrategy = { task.exitStatus in ((130..145) + 104 + 1) ? 'retry' : 'finish' }
        cpus   = { 1                   }
        memory = { task.exitStatus in ((130..145) + 104) ? 6.GB * task.attempt : 6.GB }
        time   = { task.exitStatus in ((130..145) + 104) ? 4.h  * task.attempt : 4.h }
        maxRetries = { task.exitStatus in ((130..145) + 104) ? 5 : 2 }
    }

    withName: cavemanEstep {
        errorStrategy = { task.exitStatus in ((130..145) + 104 + 1) ? 'retry' : 'finish' }
        cpus   = { 1                   }
        memory = { task.exitStatus in ((130..145) + 104) ? 6.GB * task.attempt : 6.GB }
        time   = { task.exitStatus in ((130..145) + 104) ? 4.h  * task.attempt : 4.h }
        maxRetries = { task.exitStatus in ((130..145) + 104) ? 5 : 2 }
    }
}

executor {
    name = 'lsf'
    perJobMemLimit = true
    poolSize = 4
    submitRateLimit = '10 sec'
    killBatchSize = 50
    queueSize = 500
}
