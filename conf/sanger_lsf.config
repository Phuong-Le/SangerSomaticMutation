manifest {
    name = 'config file for Sanger users, modified from The Wellcome Sanger Institute HPC cluster profile by Anthony Underwood (@aunderwo)'
    description = 'original config by Anthony Underwood (@aunderwo) https://www.sanger.ac.uk/group/informatics-support-group/'
}



process {
    resourceLimits = [
        memory: 2.9.TB,
        cpus: 256,
        time: 43200.min
        ]
    executor = 'lsf'
    // errorStrategy = { task.exitStatus in ((130..145) + 104 + 1) ? 'retry' : 'finish' }
    errorStrategy = 'retry'
    maxRetries = 3

    queue = {
        if ( task.time >= 15.day ) {
            if ( task.memory > 680.GB ) {
                error "There is no queue for jobs that need >680 GB and >15 days"
            } else {
                "basement"
            }
        } else if ( task.memory > 720.GB ) {
            "teramem"
        } else if ( task.memory > 350.GB ) {
            "hugemem"
        } else if ( task.time > 7.day ) {
            "basement"
        } else if ( task.time > 2.day ) {
            "week"
        } else if ( task.time > 12.hour ) {
            "long"
        } else if ( task.time > 1.min ) {
            "normal"
        } else {
            "small"
        }
    }


    withLabel: caveman {
        container = "/software/CASM/singularity/cgpcavemanwrapper/cgpcavemanwrapper_1.19.1.sif"
    }

    withName: cgpPindel {
        container = "/software/CASM/singularity/cgppindel/cgppindel_3.10.0.sif"
    }

    withName: cgpBigWig {
        container = "/software/CASM/singularity/pcap-core/pcap-core_5.7.0.sif"
    }

    withName: vafAugment {
        container = "/software/CASM/singularity/vafcorrect/vafcorrect_5.7.2.sif"
    }

    withLabel: vagrent {
        container = "/software/CASM/singularity/vagrent/vagrent_v3.6.1.sif"
    }

    withLabel: process_tiny {
        executor = "local"
    }


    // withName: cavemanMstep {
    //     errorStrategy = { task.exitStatus in ((130..145) + 104 + 1) ? 'retry' : 'finish' }
    //     cpus   = { 1                   }
    //     memory = { task.exitStatus in ((130..145) + 104) ? 6.GB * task.attempt : 6.GB }
    //     time   = { task.exitStatus in ((130..145) + 104) ? 12.h  * task.attempt : 12.h }
    //     maxRetries = { task.exitStatus in ((130..145) + 104) ? 3 : 2 }
    // }


    // withName: cavemanMstep {
    //     errorStrategy = { task.exitStatus in ((130..145) + 104 + 1) ? 'retry' : 'finish' }
    //     cpus   = { 1                   }
    //     memory = { task.exitStatus in ((130..145) + 104) ? 6.GB * task.attempt : 6.GB }
    //     time   = { task.exitStatus in ((130..145) + 104) ? 12.h  * task.attempt : 12.h }
    //     maxRetries = { task.exitStatus in ((130..145) + 104) ? 3 : 2 }
    // }

    withName: cavemanMstep {
        queue = 'long'
        time = 2.day
        // errorStrategy = { task.exitStatus in ((130..145) + 104 + 1) ? 'retry' : 'finish' }
        errorStrategy = 'retry'
        cpus   = { 1                   }
        memory = 6.GB
        maxRetries = 2
    }

    withName: cavemanEstep {
        // queue = { task.attempt == 1 ? 'long' : 'week'}
        // time = { task.attempt == 1 ? 2.day : 7.day }
        queue = 'week'
        time = 7.day
        // errorStrategy = { task.exitStatus in ((130..145) + 104 + 1) ? 'retry' : 'finish' }
        errorStrategy = 'retry'
        cpus   = { 1                   }
        memory = 6.GB
        maxRetries = 2
    }

}

executor {
    name = 'lsf'
    perJobMemLimit = true
    poolSize = 4
    submitRateLimit = '10 sec'
    killBatchSize = 50
    queueSize = 4000
}
